@{
  ViewData["Title"] = "Audit Logs";
    Layout = "~/Views/Shared/Dashboard/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-primary">
          <h5 class="mb-0 text-white">Audit Logs / Activity Logs</h5>
        </div>
   <div class="card-body">
     <div class="table-responsive">
          <table id="auditLogsTable" class="table table-striped table-bordered">
     <thead>
 <tr>
      <th>User</th>
<th>Action</th>
               <th>Entity</th>
          <th>Entity ID</th>
          <th>IP Address</th>
               <th>Timestamp</th>
            <th>Actions</th>
      </tr>
     </thead>
     </table>
        </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
   <div class="modal-content">
            <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">Audit Log Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>
          <div class="modal-body">
         <div class="row">
         <div class="col-md-6">
      <p><strong>User:</strong> <span id="detailUserName"></span></p>
<p><strong>Action:</strong> <span id="detailAction"></span></p>
     <p><strong>Entity:</strong> <span id="detailEntityName"></span></p>
            <p><strong>Entity ID:</strong> <span id="detailEntityId"></span></p>
   <p><strong>Timestamp:</strong> <span id="detailTimestamp"></span></p>
 </div>
   <div class="col-md-6">
            <p><strong>IP Address:</strong> <span id="detailIpAddress"></span></p>
   <p><strong>User Agent:</strong> <span id="detailUserAgent" class="text-break"></span></p>
      <p><strong>Additional Info:</strong> <span id="detailAdditionalInfo"></span></p>
    </div>
            </div>
     <hr />
  <div class="row">
        <div class="col-md-6">
  <h6>Old Values:</h6>
       <pre id="detailOldValues" class="border p-2 bg-light" style="max-height: 200px; overflow-y: auto;"></pre>
 </div>
          <div class="col-md-6">
       <h6>New Values:</h6>
          <pre id="detailNewValues" class="border p-2 bg-light" style="max-height: 200px; overflow-y: auto;"></pre>
       </div>
                </div>
     </div>
            <div class="modal-footer">
     <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
         </div>
 </div>
    </div>
</div>

@section Scripts {
    <script>
    $(document).ready(function () {
            const table = $('#auditLogsTable').DataTable({
                processing: true,
      serverSide: true,
                ajax: {
        url: '@Url.Action("GetAuditLogs", "AuditLogs")',
      type: 'GET',
      data: function (d) {
        return {
       draw: d.draw,
    start: d.start,
   length: d.length,
searchValue: d.search.value,
           sortColumn: d.columns[d.order[0].column].data,
        sortDirection: d.order[0].dir
          };
               }
      },
     columns: [
           { data: 'userName' },
          { data: 'action' },
            { data: 'entityName' },
              { data: 'entityId' },
      { data: 'ipAddress' },
     { data: 'timestamp' },
               {
       data: 'id',
   orderable: false,
              render: function (data, type, row) {
        return `<button class="btn btn-sm btn-info view-details" data-id="${data}">
                <i class="ti ti-eye"></i> View Details
       </button>`;
              }
     }
        ],
                order: [[5, 'desc']],
   pageLength: 25,
             lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]]
        });

            // View details
        $('#auditLogsTable').on('click', '.view-details', function () {
                const id = $(this).data('id');
    
       $.ajax({
    url: '@Url.Action("Details", "AuditLogs")/' + id,
    type: 'GET',
         success: function (data) {
           $('#detailUserName').text(data.userName);
           $('#detailAction').text(data.action);
         $('#detailEntityName').text(data.entityName);
  $('#detailEntityId').text(data.entityId);
          $('#detailTimestamp').text(data.timestamp);
             $('#detailIpAddress').text(data.ipAddress);
        $('#detailUserAgent').text(data.userAgent);
      $('#detailAdditionalInfo').text(data.additionalInfo);
         
      // Format JSON if available
     try {
          const oldValues = data.oldValues !== '-' ? JSON.stringify(JSON.parse(data.oldValues), null, 2) : '-';
       const newValues = data.newValues !== '-' ? JSON.stringify(JSON.parse(data.newValues), null, 2) : '-';
        $('#detailOldValues').text(oldValues);
           $('#detailNewValues').text(newValues);
         } catch (e) {
      $('#detailOldValues').text(data.oldValues);
 $('#detailNewValues').text(data.newValues);
           }
      
              $('#detailsModal').modal('show');
    },
     error: function () {
   alert('Error loading audit log details');
       }
         });
            });
  });
    </script>
}
