@using System.Security.Claims

@{
    ViewBag.Title = "Details - Study Group";
    Layout = "Dashboard/_Layout";
}

@section Styles
{
    <link rel="stylesheet" href="~/modules/study_groups/details.css" asp-append-version="true" />
}

<div class="body-wrapper">
    <div class="container-fluid">
        <div class="card bg-info-subtle shadow-none position-relative overflow-hidden mb-4">
            <div class="card-body px-4 py-3">
                <div class="row align-items-center">
                    <div class="col-9">
                        <h4 class="fw-semibold mb-8">Study Group Details</h4>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a class="text-muted text-decoration-none" asp-controller="StudyGroups"
                                       asp-action="MyStudyGroups">My Study Groups</a>
                                </li>
                                <li class="breadcrumb-item" aria-current="page">@ViewBag.StudyGroupName</li>
                            </ol>
                        </nav>
                    </div>
                    <div class="col-3">
                        <div class="text-center mb-n5">
                            <img src="~/templates/modernize/images/breadcrumb/ChatBc.png" alt="Breadcrumb logo"
                                 class="img-fluid mb-n4" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Study Group Header -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h3 class="fw-bold mb-2">@ViewBag.StudyGroupName</h3>
                        <p class="text-muted mb-2">@ViewBag.StudyGroupDescription</p>
                        <div class="d-flex gap-3 flex-wrap">
                            <span class="badge bg-primary-subtle text-primary">
                                <i class="ti ti-category me-1"></i>@ViewBag.CategoryName
                            </span>
                            <span class="badge bg-info-subtle text-info">
                                <i class="ti ti-shield-lock me-1"></i>@ViewBag.Privacy
                            </span>
                            <span class="badge bg-success-subtle text-success">
                                <i class="ti ti-users me-1"></i>@ViewBag.CurrentMemberCount @if(ViewBag.MaxMembers != null) {
                                <text>/ @ViewBag.MaxMembers</text>
                                                                }
 Members
                            </span>
                            <span class="badge bg-secondary-subtle text-secondary">
                                <i class="ti ti-calendar me-1"></i>Created: @ViewBag.CreatedAt
                            </span>
                        </div>
                    </div>
                    @if (ViewBag.IsOwner)
                    {
                        <div>
                            <a asp-controller="StudyGroups" asp-action="Upsert" asp-route-id="@ViewBag.StudyGroupId"
                               class="btn btn-primary">
                                <i class="ti ti-edit me-1"></i>Edit Group
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="card">
            <div class="card-body">
                <ul class="nav nav-pills nav-fill mb-4" id="studyGroupTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview"
                                type="button" role="tab">
                            <i class="ti ti-info-circle me-2"></i>Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="members-tab" data-bs-toggle="pill" data-bs-target="#members"
                                type="button" role="tab">
                            <i class="ti ti-users me-2"></i>Members
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="resources-tab" data-bs-toggle="pill" data-bs-target="#resources"
                                type="button" role="tab">
                            <i class="ti ti-files me-2"></i>Resources
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="forum-tab" data-bs-toggle="pill" data-bs-target="#forum"
                                type="button" role="tab">
                            <i class="ti ti-messages me-2"></i>Forum
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="meetings-tab" data-bs-toggle="pill" data-bs-target="#meetings"
                                type="button" role="tab">
                            <i class="ti ti-video me-2"></i>Meetings
                        </button>
                    </li>
                    @if (ViewBag.IsOwner)
                    {
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="requests-tab" data-bs-toggle="pill" data-bs-target="#requests"
                                    type="button" role="tab">
                                <i class="ti ti-user-check me-2"></i>Requests
                                <span class="badge bg-danger rounded-pill ms-1" id="requestCount" style="display: none;">0</span>
                            </button>
                        </li>
                    }
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="studyGroupTabContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <h5 class="fw-semibold mb-3">About This Study Group</h5>
                                <p class="mb-4">@ViewBag.StudyGroupDescription</p>

                                <div class="card bg-light-subtle mb-3">
                                    <div class="card-body">
                                        <h6 class="fw-semibold mb-3">Study Group Information</h6>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <small class="text-muted d-block">Category</small>
                                                <span class="fw-medium">@ViewBag.CategoryName</span>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <small class="text-muted d-block">Privacy</small>
                                                <span class="fw-medium">@ViewBag.Privacy</span>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <small class="text-muted d-block">Total Members</small>
                                                <span class="fw-medium">@ViewBag.CurrentMemberCount</span>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <small class="text-muted d-block">Created On</small>
                                                <span class="fw-medium">@ViewBag.CreatedAt</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border">
                                    <div class="card-body text-center">
                                        <i class="ti ti-users text-primary" style="font-size: 48px;"></i>
                                        <h4 class="fw-bold mt-3">@ViewBag.CurrentMemberCount</h4>
                                        <p class="text-muted mb-0">Active Members</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Members Tab -->
                    <div class="tab-pane fade" id="members" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-semibold mb-0">Group Members</h5>
                        </div>
                        <div id="membersGrid"></div>
                    </div>

                    <!-- Resources Tab -->
                    <div class="tab-pane fade" id="resources" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-semibold mb-0">Shared Resources</h5>
                            <button type="button" class="btn btn-primary" id="btnUploadResource">
                                <i class="ti ti-upload me-1"></i>Upload Resource
                            </button>
                        </div>
                        <div id="resourcesContainer">
                            <div class="row" id="resourcesList">
                                <!-- Resources will be loaded here -->
                            </div>
                            <div class="text-center py-5" id="resourcesEmpty">
                                <i class="ti ti-folder-off text-muted" style="font-size: 64px;"></i>
                                <p class="text-muted mt-3">No resources shared yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- Forum Tab -->
                    <div class="tab-pane fade" id="forum" role="tabpanel">
                        <div class="card bg-light-subtle mb-3">
                            <div class="card-body">
                                <h5 class="fw-semibold mb-3">Post a Message</h5>
                                <textarea class="form-control mb-3" id="forumMessage" rows="3"
                                          placeholder="Share your thoughts, questions, or updates..."></textarea>
                                <button type="button" class="btn btn-primary" id="btnPostMessage">
                                    <i class="ti ti-send me-1"></i>Post Message
                                </button>
                            </div>
                        </div>
                        <div id="forumMessages">
                            <!-- Messages will be loaded here -->
                        </div>
                        <div class="text-center py-5" id="forumEmpty">
                            <i class="ti ti-message-circle-off text-muted" style="font-size: 64px;"></i>
                            <p class="text-muted mt-3">No messages yet. Start the conversation!</p>
                        </div>
                    </div>

                    <!-- Meetings Tab -->
                    <div class="tab-pane fade" id="meetings" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card border h-100">
                                    <div class="card-body text-center">
                                        <div class="mb-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64">
                                                <path fill="#4285F4" d="M32 0C14.3 0 0 14.3 0 32s14.3 32 32 32 32-14.3 32-32S49.7 0 32 0z" />
                                                <path fill="#34A853" d="M32 12c11 0 20 9 20 20s-9 20-20 20-20-9-20-20 9-20 20-20z" />
                                                <path fill="#FBBC05" d="M32 20c6.6 0 12 5.4 12 12s-5.4 12-12 12-12-5.4-12-12 5.4-12 12-12z" />
                                                <path fill="#EA4335" d="M28 28h8v8h-8z" />
                                            </svg>
                                        </div>
                                        <h5 class="fw-semibold mb-2">Google Meet</h5>
                                        <p class="text-muted mb-3">Join video meetings with your study group</p>
                                        <input type="text" class="form-control mb-3" id="meetLink"
                                               placeholder="Enter Google Meet link" value="">
                                       @*  @if (ViewBag.IsOwner)
                                        {
                                            <button type="button" class="btn btn-primary w-100 mb-2" id="btnSaveMeetLink">
                                                <i class="ti ti-device-floppy me-1"></i>Save Meeting Link
                                            </button>
                                        } *@
                                        <button type="button" class="btn btn-success w-100" id="btnJoinMeet">
                                            <i class="ti ti-video me-1"></i>Join Meeting
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card border h-100">
                                    <div class="card-body">
                                        <h5 class="fw-semibold mb-3">
                                            <i class="ti ti-link me-2"></i>Invite Link
                                        </h5>
                                        @if (ViewBag.IsOwner)
                                        {
                                            @if (ViewBag.IsApproved)
                                            {
                                                <div id="inviteLinkSection">
                                                    <p class="text-muted mb-3">Share this link with others to invite them to join the study group.</p>

                                                    <div id="noInviteLink">
                                                        <div class="text-center py-4 mb-3">
                                                            <i class="ti ti-link-off text-muted" style="font-size: 48px;"></i>
                                                            <p class="text-muted mt-2 mb-0">No active invite link</p>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Link Expiration (Optional)</label>
                                                            <select class="form-select" id="inviteExpiration">
                                                                <option value="">No expiration</option>
                                                                <option value="1">1 day</option>
                                                                <option value="7">7 days</option>
                                                                <option value="30">30 days</option>
                                                                <option value="90">90 days</option>
                                                            </select>
                                                        </div>
                                                        <button type="button" class="btn btn-primary w-100" id="btnGenerateInvite">
                                                            <i class="ti ti-link-plus me-1"></i>Generate Invite Link
                                                        </button>
                                                    </div>

                                                    <div id="activeInviteLink" style="display: none;">
                                                        <div class="input-group mb-3">
                                                            <input type="text" class="form-control" id="inviteLinkInput" readonly>
                                                            <button class="btn btn-outline-primary" type="button" id="btnCopyInvite">
                                                                <i class="ti ti-copy"></i>
                                                            </button>
                                                        </div>
                                                        <div id="inviteExpiry" class="alert alert-info mb-3" style="display: none;">
                                                            <small><i class="ti ti-clock me-1"></i>Expires: <span id="expiryDate"></span></small>
                                                        </div>
                                                        <button type="button" class="btn btn-danger w-100 mb-2" id="btnRevokeInvite">
                                                            <i class="ti ti-trash me-1"></i>Revoke Link
                                                        </button>
                                                        <button type="button" class="btn btn-success w-100" id="btnShareInvite">
                                                            <i class="ti ti-share me-1"></i>Share Link
                                                        </button>
                                                    </div>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="alert alert-warning mb-0">
                                                    <i class="ti ti-alert-triangle me-2"></i>
                                                    <strong>Approval Required</strong><br />
                                                    This study group must be approved by an administrator before you can generate invite links.
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="alert alert-info mb-0">
                                                <i class="ti ti-info-circle me-2"></i>
                                                Only the group owner can manage invite links.
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="card border h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="fw-semibold mb-0">
                                                <i class="ti ti-calendar-event me-2"></i>Meeting Schedule
                                            </h5>
                                            @if (ViewBag.IsOwner)
                                            {
                                                <button type="button" class="btn btn-primary btn-sm" id="btnCreateMeeting">
                                                    <i class="ti ti-plus me-1"></i>Schedule Meeting
                                                </button>
                                            }
                                        </div>
                                        <div id="meetingSchedule">
                                            <!-- Meetings will be loaded here -->
                                        </div>
                                        <div class="text-center py-4 text-muted" id="meetingsEmpty">
                                            <i class="ti ti-calendar-off" style="font-size: 48px;"></i>
                                            <p class="mt-2">No upcoming meetings</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Membership Requests Tab (Owner Only) -->
                    @if (ViewBag.IsOwner)
                    {
                        <div class="tab-pane fade" id="requests" role="tabpanel">
                            <h5 class="fw-semibold mb-3">Membership Requests</h5>
                            <div id="requestsGrid"></div>
                            <div class="text-center py-5" id="requestsEmpty">
                                <i class="ti ti-user-check text-muted" style="font-size: 64px;"></i>
                                <p class="text-muted mt-3">No pending membership requests</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Resource Modal -->
<div class="modal fade" id="uploadResourceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadResourceForm">
                    <div class="mb-3">
                        <label for="resourceTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="resourceTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="resourceDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="resourceDescription" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="resourceFile" class="form-label">File</label>
                        <input type="file" class="form-control" id="resourceFile"
                               accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.jpg,.jpeg,.png,.gif" required>
                        <small class="text-muted">Supported: PDF, Word, PowerPoint, Excel, Images</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnSubmitResource">Upload</button>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Meeting Modal -->
<div class="modal fade" id="meetingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="meetingModalTitle">Schedule Meeting</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="meetingForm">
                    <input type="hidden" id="meetingId">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="meetingTitle" class="form-label">Meeting Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="meetingTitle" placeholder="e.g., Weekly Study Session" required>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="meetingDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="meetingDescription" rows="3" placeholder="What will be discussed in this meeting?"></textarea>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="meetingLink" class="form-label">Google Meet Link <span class="text-danger">*</span></label>
                            <input type="url" class="form-control" id="meetingLink" placeholder="https://meet.google.com/xxx-xxxx-xxx" required>
                            <small class="text-muted">Enter the full Google Meet URL</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="meetingStartTime" class="form-label">Start Date & Time <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="meetingStartTime" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="meetingEndTime" class="form-label">End Date & Time <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="meetingEndTime" required>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="meetingMaxParticipants" class="form-label">Maximum Participants (Optional)</label>
                            <input type="number" class="form-control" id="meetingMaxParticipants" min="1" max="250" placeholder="Leave empty for unlimited">
                            <small class="text-muted">Google Meet free version supports up to 100 participants</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnSubmitMeeting">
                    <i class="ti ti-device-floppy me-1"></i>Save Meeting
                </button>
            </div>
        </div>
    </div>
</div>

@section FooterScripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
           var studyGroupId = @ViewBag.StudyGroupId;
        var isOwner = @(ViewBag.IsOwner ? "true" : "false");
             var isMember = @(ViewBag.IsMember ? "true" : "false");
             var currentUserId = '@User.FindFirstValue(System.Security.Claims.ClaimTypes.NameIdentifier)';
    </script>
    <script src="~/modules/study_groups/footer_details.js" asp-append-version="true"></script>
}